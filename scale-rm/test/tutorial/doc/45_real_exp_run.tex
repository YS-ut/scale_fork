
%-------------------------------------------------------%
\section{時間積分を行う：run}
%-------------------------------------------------------%
\subsubsection{run.confの準備}
runディレクトリへ移動する。
\begin{verbatim}
 $ cd ${Tutorial_DIR}/real/run
\end{verbatim}
%
runディレクトリの中には、\verb|run.conf|という名前の
設定ファイルが準備されており、
ドメインの位置や格子点数など、
チュートリアル用の設定（表\ref{tab:grids}）に合わせて設定されている。\\

\noindent {\small {\gt
\ovalbox{
\begin{tabularx}{140mm}{l}
\verb|&PARAM_PRC| \\
\verb| PRC_NUM_X      = 2,| \\
\verb| PRC_NUM_Y      = 2,| \\
\verb| PRC_PERIODIC_X = .false.,| \\
\verb| PRC_PERIODIC_Y = .false.,| \\
\verb|/| \\
 \\
\verb|&PARAM_INDEX| \\
\verb| KMAX = 36,| \\
\verb| IMAX = 45,| \\
\verb| JMAX = 45,| \\
\verb|/| \\
\end{tabularx}
}}}\\


X方向、Y方向ともに2分割されており、
総計として4つのMPIプロセスを使用する設定となっている。
1つのMPIプロセスあたりの格子点数については、
\verb|IMAX = 45|、\verb|JMAX = 45|と指定されているため、
X方向、Y方向の総格子点数は、ともに$2 \times 45$ で90である。
計算ドメインの大きさは、
\verb|PARAM_GRID|の項目の\verb|DX|、\verb|DY|はともに20000 m（20 km）
と指定されているため、
90 個$\times$ 20 km より、1800 km $\times$ 1800 km の正方形の計算領域
が設定されていることがわかる。


モデル本体の実行には
事前に作成した地形・土地利用データや初期値・境界値データを利用する。
これらのファイルの指定は、
\verb|run.conf|の下記部分で設定する。\\

\noindent {\gt
\ovalbox{
\begin{tabularx}{140mm}{l}
\verb|&PARAM_TOPO| \\
\verb|   TOPO_IN_BASENAME = "../pp/topo_d01",| \\
\verb|/| \\
 \\
\verb|&PARAM_LANDUSE| \\
\verb|   LANDUSE_IN_BASENAME  = "../pp/landuse_d01",| \\
\verb|/| \\
 \\
\verb|&PARAM_RESTART| \\
\verb|   RESTART_OUTPUT      = .false.,| \\
\verb|   RESTART_IN_BASENAME = "../init/init_d01_20140714-180000.000",| \\
\verb|/| \\
 \\
\verb|&PARAM_ATMOS_BOUNDARY| \\
\verb|   ATMOS_BOUNDARY_TYPE        = "REAL",| \\
\verb|   ATMOS_BOUNDARY_IN_BASENAME = "../init/boundary_d01",| \\
\verb|   ATMOS_BOUNDARY_USE_VELZ    = .true.,| \\
\verb|   ATMOS_BOUNDARY_USE_QHYD    = .false.,| \\
\verb|   ATMOS_BOUNDARY_VALUE_VELZ  = 0.0D0,| \\
\verb|   ATMOS_BOUNDARY_UPDATE_DT   = 21600.0D0,| \\
\verb|/| \\
\end{tabularx}
}}\\


\verb|run.conf|の設定の中で時間積分に関する設定は、
\verb|PARAM_TIME|の項目にある。\\

\noindent {\gt\small
\ovalbox{
\begin{tabularx}{150mm}{ll}
\verb|&PARAM_TIME| & \\
\verb| TIME_STARTDATE     = 2007, 7, 14, 0, 0, 0,| &← 時間積分を開始する時刻 \\
\verb| TIME_STARTMS       = 0.D0,| &\\
\verb| TIME_DURATION      = 6.0D0,| &← 積分期間 \\
\verb| TIME_DURATION_UNIT = "HOUR",| &← \verb|TIME_DURATION|の単位\\
\verb| TIME_DT            = 90.0D0,| &← トレーサー移流計算の時間ステップ\\
\verb| TIME_DT_UNIT       = "SEC",|  &← \verb|TIME_DT|の単位\\
\verb| TIME_DT_ATMOS_DYN  = 45.0D0,| &← トレーサー移流計算以外の力学過程の時間ステップ\\
\verb| TIME_DT_ATMOS_DYN_UNIT = "SEC",| &← \verb|TIME_DT_ATMOS_DYN|の単位\\
 \\
\verb| ～～中略～～| &\\
 \\
\verb|/| &\\
\end{tabularx}
}}\\

\noindent 初期時刻\verb|TIME_STARTDATE|はUTCで指定する。
チュートリアルでは2007年7月14日18時UTCに設定している。
積分のための時間ステップは、上記の他、
それぞれの物理スキーム毎に設定できるようになっている。


計算結果の出力に関する設定は\verb|PARAM_HISTORY|で行う。\\

\noindent {\gt
\ovalbox{
\begin{tabularx}{140mm}{l}
\verb|&PARAM_HISTORY| \\
\verb|   HISTORY_DEFAULT_BASENAME  = "history_d01",| 　← 出力するファイル名\\
\verb|   HISTORY_DEFAULT_TINTERVAL = 3600.D0,| 　 　 　← 出力時間間隔\\
\verb|   HISTORY_DEFAULT_TUNIT     = "SEC",| 　 　 　 　 　← 出力時間間隔の単位\\
\verb|   HISTORY_DEFAULT_TAVERAGE  = .false.,| \\
\verb|   HISTORY_DEFAULT_DATATYPE  = "REAL4",| \\
\verb|   HISTORY_DEFAULT_ZINTERP   = .false.,| 　← 出力時に高さ面へ内挿するかどうか\\
\verb|   HISTORY_OUTPUT_STEP0      = .true.,| 　← 初期時刻(t=0)の値を出力するかどうか\\
\verb|/| \\
\end{tabularx}
}}\\

\noindent 上記の設定に従って、下記の\verb|HISTITEM|に羅列された変数が出力される。
\verb|HISTITEM|ではオプション変数を加えることで、変数毎に、出力間隔を変更したり、
平均値を出力したりすることも可能である。
これらの説明は\ref{sec:output}を参照されたい。\\

\noindent {\small {\gt
\ovalbox{
\begin{tabularx}{150mm}{l}
\verb|&HISTITEM item="DENS" / 　  　        　! density (3D)| \\
\verb|&HISTITEM item="MOMZ" / 　  　        　! vertical momentum (3D)| \\
\verb|&HISTITEM item="MOMX" / 　  　        　! horizontal momentum-x (3D)| \\
\verb|&HISTITEM item="MOMY" / 　  　        　! horizontal momentum-y (3D)| \\
\verb|&HISTITEM item="RHOT" / 　  　        　! density * potential-temperature (3D)| \\
\verb|&HISTITEM item="QV"   / 　  　    　    　! mixing ratio for vapor (3D)| \\
\verb|&HISTITEM item="QHYD" / 　  　        　! mixing ratio for hydrometeor (3D)| \\
\verb|&HISTITEM item="T"    / 　  　     　   　! temperature (3D)| \\
\verb|&HISTITEM item="PRES" / 　  　        　! pressure (3D)| \\
\verb|&HISTITEM item="U"    / 　  　      　  　! horizontal wind component-x (3D)| \\
\verb|&HISTITEM item="V"    / 　  　      　  　! horizontal wind component-y (3D)| \\
\verb|&HISTITEM item="W"    / 　  　      　  　! vertical wind component (3D)| \\
\verb|&HISTITEM item="PT"   / 　  　   　     　! potential temperature (3D)| \\
\verb|&HISTITEM item="RH"   / 　   　   　    　! relative humidity (3D)| \\
\verb|&HISTITEM item="PREC" / 　   　    　   ! precipitation (2D)| \\
\verb|&HISTITEM item="OLR"  / 　    　       　 ! out-going longwave radiation(2D)| \\
\verb|&HISTITEM item="U10" / 　     　       　 ! horizontal wind component-x at 10m height(2D)| \\
\verb|&HISTITEM item="V10" / 　     　       　 ! horizontal wind component-y at 10m height(2D)| \\
\verb|&HISTITEM item="T2"  / 　     　  　    　! temperature at 2m height (2D)| \\
\verb|&HISTITEM item="Q2"  / 　     　  　    　! mixing ratio for vapor at 2m height (2D)| \\
\verb|&HISTITEM item="SFC_PRES"   / 　    　! pressure at the bottom surface (2D)| \\
\verb|&HISTITEM item="SFC_TEMP"   / 　    　! temperature a the bottom surface (2D)| \\
\verb|&HISTITEM item="LAND_SFC_TEMP" /  ! temperature a the bottom surface for land model (2D)| \\
\verb|&HISTITEM item="URBAN_SFC_TEMP"/ ! temperature a the bottom surface for urban model (2D)| \\
\end{tabularx}
}}}\\

\noindent その他に実験で使用される物理過程の設定は、
\verb|PARAM_TRACER，PARAM_ATMOS，PARAM_OCEAN，PARAM_LAND，PARAM_URBAN|の項目に
記述されている。
詳細な設定ファイルの内容については、付録\ref{app:namelist}を参照されたい。

%
\subsubsection{実行}
コンパイル済みのバイナリをrunディレクトリへリンクする。

\begin{verbatim}
 $ ln -s ../../bin/scale-rm ./
\end{verbatim}
陸面過程や放射過程のモデルを起動するためのパラメータファイルに
リンクを張る。
\begin{verbatim}
 $ ln -s ../../../data/land/* ./   <- 陸面スキーム用のパラメータファイル
 $ ln -s ../../../data/rad/*  ./   <- 放射スキーム用のパラメータファイル
\end{verbatim}
準備が整ったら、4-MPI並列によりscale-rmを実行する。
\begin{verbatim}
  $ mpirun -n 4 ./scale-rm run.conf >& log &
\end{verbatim}


実行にはある程度時間を要するため、
上記のように標準出力をファイルへ書き出すようにして
バックグラウンドで実行すると便利である。
計算が開始されれば，処理内容のログとして、
\verb|"LOG_d01.pe000000"|が生成される。
さらに、ジョブが正常に終了すると、
\begin{verbatim}
 $ ls
  history_d01.pe000000.nc
  history_d01.pe000001.nc
  history_d01.pe000002.nc
  history_d01.pe000003.nc
\end{verbatim}
が作成される。
\verb|history_d01.pe######.nc|は
\verb|HISTITEM|に指定した出力変数が書き出される。
\verb|######|はMPIプロセス番号を表している。


%####################################################################################

