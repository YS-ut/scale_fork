%-------------------------------------------------------------------------------
\section{SCALE NetCDF Operator (\sno)} \label{sec:sno}
%-------------------------------------------------------------------------------

\noindent {\Large\em NOTICE} \hrulefill

\sno is a post-processing tool for the \scalenetcdf file generated by the \scalelib version 5.3 or newer.
\sno is not available for the older version's \scalenetcdf files because of the less information about the global attributes and the attributes of the axis data.
net2g (Sec. \ref{sec:net2g}) can be used for the older version's \scalenetcdf files.

\hrulefill\\


Unless the Parallel \netcdf (\pnetcdf) (Sec. \ref{subsec:single_io}) is employed,
the output file of \scalerm, i.e., \scalenetcdf file, is divided according to the horizontal domain decomposition by the multiple processes.
Although this style is efficient to the throughput of the file I/O during the model simulation, it is a disadvantage in the following points.
%
1) When the number of MPI processes is large, it is hard to handle a lot of files because the number of the files increases along with the number of MPI processes.
2) Even if we use the same experimental settings across multiple experiments except for the number of MPI processes, we cannot share the init/boundary/restart/history files between the experiments.
3) many analytical and visualization tools do not support such the spacially-distributed files.


\sno has the following features to reduce the annoyance of handling these distributed files.
The format in the parentheses indicates the supported output format from \sno.
\begin{itemize}
 \item Combine the divided multiple files into a single file (\scalenetcdf, \grads binary).
 \item Convert a single file or multiple files into multiple files with different number of divisions  (\scalenetcdf).
% \item Generate a control file (*.ctl) for reading a single \Netcdf file by \grads
 \item Regrid data from the model-level coordinate to the pressure-level coordinate (\scalenetcdf).
 \item Regrid data from the model grid to the geodesic (latitude-longitude) grid coordinate (\scalenetcdf).
 \item Average history data over multiple steps (\scalenetcdf).
\end{itemize}



\subsubsection{Basic usage}

The settings for \sno are specified in \namelist{PARAM_SNO}.
%
\editboxtwo{
\verb|&PARAM_SNO                  | & \\
\verb| basename_in     = "",      | & ; Path and basename of the input file(s) \\
\verb| basename_out    = "",      | & ; (\scalenetcdf) Basename of the output file \\
\verb| nprocs_x_out    = 1,       | & ; (\scalenetcdf) Division number of file in x-direction \\
\verb| nprocs_y_out    = 1,       | & ; (\scalenetcdf) Division number of file in y-direction \\
\verb| output_single   = .false., | & ; (\scalenetcdf) Whether output to a single \netcdf file when using multiple MPI processes? \\
\verb| dirpath_out     = "",      | & ; (\grads) Directory path of a output file \\
\verb| output_grads    = .false., | & ; (\grads) Output with grads format? \\
\verb| output_gradsctl = .false., | & ; Output a grads control file when outputting a single \netcdf file? \\
\verb| vars            = "",      | & ; Name of variables to operate \\
\verb| debug           = .false., | & ; Output verbose log for debugging? \\
\verb|/                           | & \\
}

\nmitem{basename_in} is always required.
The information of the divided files, such as the total number of files and the 2-D topology, is read from the first file (\verb|*.pe000000.nc|).

If \nmitem{vars} is not specified, all of variables in the input file are processed.

\nmitem{basename_out} is the basename of output file when the output format is \scalenetcdf.
\nmitem{nprocs_x_out} and \nmitem{nprocs_y_out} specify the division number of output file.
The default value of \nmitem{nprocs_x_out} and \nmitem{nprocs_y_out} is 1; it means that multiple files are combined to a single file.
The number of MPI processes for SNO must be same as, or less than the total number of output files (= \nmitem{nprocs_x_out} x \nmitem{nprocs_y_out}).
Note that, if \nmitem{output_single}  = \verb|.true.| ,
distributed data is merged and output in a single file regardless of the number of MPI processes specified by \nmitem{nprocs_x_out} and \nmitem{nprocs_y_out}.


If \nmitem{output_grads} is set to \verb|.true.|, data is output in a single file with binary format, readable by \grads.
In this case, the number of MPI processes must be one.
If \nmitem{dirpath_out} is empty, the directory path for output is set to the current directory.

When \nmitem{output_gradsctl} = \verb|.true.|, \sno outputs a control file for \grads.
Note that, this option is avairable when \nmitem{nprocs_x_out} = 1 and \nmitem{nprocs_y_out} = 1.


In addition to \namliest{PARAM_SNO}, \sno can use the following namelist parameters:
%
\begin{itemize}
 \item \namelist{PARAM_IO}: Log file (Sec. \ref{sec:log})
 \item \namelist{PARAM_PROF}: Performance Profiler (Sec. \ref{subsec:prof})
 \item \namelist{PARAM_CONST}: Physical Constants (Sec. \ref{subsec:const})
 \item \namelist{PARAM_CALENDAR}: Calendar (Sec. \ref{subsec:calendar})
\end{itemize}



\subsection{Samples of configuration: conversion of data format and division numbers}

\subsubsection{Convert multiple \scalenetcdf files to a single NetCDF file (single MPI process)}
%
\editbox{
\verb|&PARAM_SNO                                    | \\
\verb| basename_in     = 'input/history_d02',       | \\
\verb| basename_out    = 'output/history_d02_new',  | \\
\verb| output_gradsctl = .true.,                    | \\
\verb|/                                             | \\
}
%
This example converts history files named \verb|history_d02.pe######.nc| in the directory \verb|./input|, where \verb|######| represents the MPI process number.
The input files are combined and output to a single file including all variables are kept,
because any options about the number of output file and variables are not specified in this example.
The converted file is output to \verb|./output| directory with the new name \verb|history_d02_new.pe######.nc|.

When \nmitem{output_gradsctl} is \verb|.true.|, \sno outputs a control file for \grads.
This option is valid only when the number of executive processes is one.
%
Generally, a single \netcdf file is readable by \grads without any extrnal metadata file. However, \grads interface is limited and cannot understand the \scalenetcdf format, which contains the assosiated coodinates and the map projections. That is because we need the control file.
The following is an example of the output control file.
%
\msgbox{
\verb|SET ^history_d02_new.pe000000.nc| \\
\verb|TITLE SCALE-RM data output| \\
\verb|DTYPE netcdf| \\
\verb|UNDEF -0.99999E+31| \\
\verb|XDEF    88 LINEAR    134.12     0.027| \\
\verb|YDEF    80 LINEAR     33.76     0.027| \\
\verb|ZDEF    35 LEVELS| \\
\verb|   80.841   248.821   429.882   625.045   835.409  1062.158  1306.565  1570.008  1853.969| \\
\verb| 2160.047  2489.963  2845.574  3228.882  3642.044  4087.384  4567.409  5084.820  5642.530| \\
\verb| 6243.676  6891.642  7590.075  8342.904  9154.367 10029.028 10971.815 11988.030 13083.390| \\
\verb|14264.060 15536.685 16908.430 18387.010 19980.750 21698.615 23550.275 25546.155| \\
\verb|TDEF    25  LINEAR  00:00Z01MAY2010   1HR| \\
\verb|PDEF    80    80 LCC     34.65    135.22    40    40     30.00     40.00    135.22   2500.00   2500.00| \\
\verb|VARS    3| \\
\verb|U=>U   35 t,z,y,x velocity u| \\
\verb|PREC=>PREC    0 t,y,x surface precipitation flux| \\
\verb|OCEAN_SFC_TEMP=>OCEAN_SFC_TEMP    0 t,y,x ocean surface skin temperature| \\
\verb|ENDVARS| \\
}


\subsubsection{Convert multiple \scalenetcdf files to a single NetCDF file (multiple MPI processes)}
%
\editbox{
\verb|&PARAM_SNO                               | \\
\verb| basename_in     = 'input/history_d02',  | \\
\verb| basename_out    = 'output/history_d02', | \\
\verb| nprocs_x_out    = 4,                    | \\
\verb| nprocs_y_out    = 6,                    | \\
\verb| output_single   = .true.,               | \\
\verb|/                                        | \\
}

Although the conversion is done by using 24 MPI processes in this example, the output file is a single file because \nmitem{output_single} = \verb|.true.|.
All variables are included in the output file.

\nmitem{output_gradsctl} is not available, it is impossible to automatically create the control file for \grads.
You can read the output file with \scalenetcdf format by using \grads if you prepare the control file by yourself.
Note that this conversion method is not allowed to apply for the history files from the experiment using the cyclic boundary.



\subsubsection{Convert multiple \scalenetcdf files to multiple \Netcdf files with different number of divisions}
%
\editbox{
\verb|&PARAM_SNO                            | \\
\verb| basename_in  = 'input/history_d02',  | \\
\verb| basename_out = 'output/history_d02', | \\
\verb| nprocs_x_out = 4,                    | \\
\verb| nprocs_y_out = 6,                    | \\
\verb|/                                     | \\
}

When reorganizing multiple files, there is a restriction that each reorganized output file must have the same number of grids (excluding the halo grid).
To satisfy this restriction, \nmitem{nprocs_x_out} must be a divisor of the total grid number (\verb|IMAXG|) of {\XDIR} of the entire domain (see Sec. \ref{sec:domain}). \nmitem{nprocs_y_out} also has the same restrition with \nmitem{nprocs_x_out}.
The number of MPI processes to execute \sno must be set the number of divisions you want to convert, i.e., \nmitem{nprocs_x_out} $\times$ \nmitem{nprocs_y_out}.


In the above example, give the number of input file is 4 ([x,y]=[2,2]) and
each file has 30 grid cells in each of x- and y-directions  except for halo.
That is, the number of total grid cells of the entire domain is 60 $\times$ 60.
%
Because the number of output file is 24 ([x,y]=[4,6]),
output file have 15 and 10 grid cells for x- and y- direction, respectively.


You can get the informations for redistribution by checking the global attribute in \scalenetcdf file.
For example, you can display the header informations by using ``ncdump'' command as follows:

\begin{alltt}
  $  ncdump -h history_d02.pe000000.nc
\end{alltt}

You will find the global attributes at the end of dumped information.

\msgbox{
\verb|  ......                                           | \\
\verb|// global attributes:                              | \\
\verb|  ......                                           | \\
\verb|     :scale_cartesC_prc_rank_x = 0 ;               | \\
\verb|     :scale_cartesC_prc_rank_y = 0 ;               | \\
\verb|     :scale_cartesC_prc_num_x = 2 ;                | \\
\verb|     :scale_cartesC_prc_num_y = 2 ;                | \\
\verb|  ......                                           | \\
\verb|     :scale_atmos_grid_cartesC_index_imaxg = 60 ;  | \\
\verb|     :scale_atmos_grid_cartesC_index_jmaxg = 60 ;  | \\
\verb|  ......                                           | \\
}

\verb|scale_cartesC_prc_num_x| and \verb|scale_cartesC_prc_num_y| are the sizes of x- and y-direction in the 2-D file topology, respectively. \verb|scale_cartesC_prc_rank_x| and \verb|scale_cartesC_prc_rank_y| are the x- and y-positions of this file in the 2-D map, respectively. The rank number starts from 0.
\verb|scale_atmos_grid_cartesC_index_imaxg| and \verb|scale_atmos_grid_cartesC_index_jmaxg| are the total number of grid cells in x- and y-directions, respectively. These numbers do not contain halo grid.
For other attribute information, refer to the table \ref{table:netcdf_global_attrs} in Sec. \ref{sec:global_attr}.




\subsubsection{Convert multiple \scalenetcdf files to \grads format file}
%
\editbox{
\verb|&PARAM_SNO                                | \\
\verb| basename_in  = 'input/history_d02',      | \\
\verb| dirpath_out  = 'output',                 | \\
\verb| output_grads = .true.,                   | \\
\verb| vars         = "U", "PREC", "LAND_TEMP", | \\
\verb|/                                         | \\
}

If \nmitem{output_grads} is \verb|.true.|, all of the decomposed data is combined spatially and output into a single file with \grads binary format.
The conversion is applied to the variables specified by \nmitem{vars}.
The \grads format file cannot contain the plural variables with the different vertical layer.
Thus each variable is output to the individual aggregated file.
Each file name is set to be the same as a variable name. The control files are also generated.
The converted file is output to \verb|./output| directory. Note that the output path, i.e., \nmitem{dirpath_out}, will not be set if you specify \nmitem{basename_out}.




\subsection{Samples of configuration: plugin functions}

You can apply the operators, such as time averaging and horizontal/vertical remapping, before outputting the combined/divided files.

\subsubsection{Temporally averaging}

The settings for time averaging are specified by \namelist{PARAM_SNOPLGIN_TIMEAVE}.
%
\editbox{
\verb|&PARAM_SNO                             | \\
\verb| basename_in  = 'input/history_d02',   | \\
\verb| basename_out = 'output/history_d02',  | \\
\verb| nprocs_x_out = 2,                     | \\
\verb| nprocs_y_out = 2,                     | \\
\verb|/                                      | \\
\verb|                                       | \\
\verb|&PARAM_SNOPLGIN_TIMEAVE                | \\
\verb| SNOPLGIN_timeave_type     = 'NUMBER', | \\
\verb| SNOPLGIN_timeave_interval = 4,        | \\
\verb|/                                      | \\
}

When \nmitem{SNOPLGIN_timeave_type} is set to \verb|'NUMBER'|, the data is averaged in time axis.
The interval of time average is specified by \nmitem{SNOPLGIN_timeave_interval}.
In this sample, the variables is averaged by every 4 output-steps.
The output files is divided into 2 $\times$ 2, namely, the number of output file is 4.


The other sample is as follows:
%
\editbox{
\verb|&PARAM_SNO                            | \\
\verb| basename_in  = 'input/history_d02',  | \\
\verb| basename_out = 'output/history_d02', | \\
\verb|/                                     | \\
\verb|                                      | \\
\verb|&PARAM_SNOPLGIN_TIMEAVE               | \\
\verb| SNOPLGIN_timeave_type = 'MONTHLY',   | \\
\verb|/                                     | \\
}

Both the file aggregation and the time averaging are applied in this sample.\\
When \nmitem{SNOPLGIN_timeave_type} is set to \verb|'DAILY'|, \verb|'MONTHLY'|, or \verb|'ANNUAL'|, \sno try to daily, monthly, annual average of the variables. The date and time of the data are read from the file.
If you used ideal calendar for the simulation, the setting of \namelist{PARAM_CALENDAR} should be added to the configuration file of \sno (Please see Sec. \ref{subsec:calendar}).



\subsubsection{Regrid data to the grid with an interval of 0.5 degree}

The settings for regrid of data on the lat-lon coordinate are specified by \namelist{PARAM_SNOPLGIN_HGRIDOPE}.
%
\editbox{
\verb|&PARAM_SNO                               | \\
\verb| basename_in  = 'input/history_d02',     | \\
\verb| basename_out = 'output/history_d02',    | \\
\verb|/                                        | \\
\verb|                                         | \\
\verb|&PARAM_SNOPLGIN_HGRIDOPE                 | \\
\verb| SNOPLGIN_hgridope_type      = 'LATLON', | \\
\verb| SNOPLGIN_hgridope_lat_start = 30.0,     | \\
\verb| SNOPLGIN_hgridope_lat_end   = 40.0,     | \\
\verb| SNOPLGIN_hgridope_dlat      = 0.5,      | \\
\verb| SNOPLGIN_hgridope_lon_start = 130.0,    | \\
\verb| SNOPLGIN_hgridope_lon_end   = 140.0,    | \\
\verb| SNOPLGIN_hgridope_dlon      = 0.5,      | \\
\verb|/                                        | \\
}

When \nmitem{SNOPLGIN_hgridope_type} is set to \verb|'LATLON'|, horizontal remapping to the latitude-longitude grid system is applied.
This plugin operator can be available only when the output file is single.
The other options in \namelist{PARAM_SNOPLGIN_HGRIDOPE} set the domain boundary and grid interval of output data. The size of longitude grid point \verb|nlon| is calculated as follows:
\begin{eqnarray}
  \nmitemeq{nlon} = \frac{\nmitemeq{SNOPLGIN_hgridope_lon_end} - \nmitemeq{SNOPLGIN_hgridope_lon_start} }{\nmitemeq{SNOPLGIN_hgridope_dlon}} \nonumber.
\end{eqnarray}
\noindent
The result of this calculation is rounded to an integer. Thus, the easternmost grid point may be located in the westside of \nmitem{SNOPLGIN_hgridope_lon_end}.
The latitude grid point is calculated in the same manner as that of longitude.

You can set the lat-lon domain larger than the original domain size used in the simulation. In remapping process, extrapolation is not allowed. An missing value is filled to the grid, which has no interpolated value.


\subsubsection{Regrid data to pressure-level coordinate}

The settings for regrid of data on pressure-level corrdinate are specified by \namelist{PARAM_SNOPLGIN_VGRIDOPE}.
%
\editbox{
\verb|&PARAM_SNO                                               | \\
\verb| basename_in  = 'input/history_d02',                     | \\
\verb| basename_out = 'output/history_d02',                    | \\
\verb|/                                                        | \\
\verb|                                                         | \\
\verb|&PARAM_SNOPLGIN_VGRIDOPE                                 | \\
\verb| SNOPLGIN_vgridope_type     = 'PLEV',                    | \\
\verb| SNOPLGIN_vgridope_lev_num  = 3,                         | \\
\verb| SNOPLGIN_vgridope_lev_data = 850.e+2, 500.e+2, 200.e+2, | \\
\verb|/                                                        | \\
}

When \nmitem{SNOPLGIN_vgridope_type} in \namelist{PARAM_SNOPLGIN_VGRIDOPE} is set to \verb|'PLEV'|, vertical remapping to the pressure-coordinate system is applied.
\nmitem{SNOPLGIN_vgridope_lev_num} is the number of vertical layers, and \nmitem{SNOPLGIN_vgridope_lev_data} specifies the pressure-level at which you want to convert data.
The unit of pressure-level is $[Pa]$.
This plugin operator is available when the output file is multiple.
Note that pressure data (\verb|PRES|) is required in the input file.
