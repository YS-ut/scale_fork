\subsection{Offline Nesting Experiment} \label{subsec:nest_offline}
%------------------------------------------------------

The following two limitations are imposed for the offline nesting experiment:
\begin{itemize}
 \item The child domain is completely included in the parent domain.
 \item The integration time for the child domain is the same as or less than that for the parent domain.
\end{itemize}
Furthermore, the offline experiment is conducted in the following order:
\begin{enumerate}
 \item The temporal integration of the parent domain is conducted.
 \item The initial and boundary conditions for the child domain are generated using the history output of the parent domain.
 \item Using the generated initial and boundary conditions, the temporal integration of the child domain is conducted.
\end{enumerate}
An explanation is provided according to the above workflow.


\subsubsection{Time Integration of Parent Domain}

In order to prepare the data in parent domain which is used as the boundary data for the child domain, there are some necessary settings.
The configuration files for the simulation in the parent domain can be generated by using ``the supporting tool for the preparation of configuration file'' (See \ref{sec:basic_makeconf}).
Rename the sample files \\ \verb|${Tutorial_dir}/real/sample/USER.offline-nesting-parent.sh| to \verb|USER.sh|, and run \verb|make|.

The time integration of the parent domain is carried out as a single-domain computation. However, the following five aspects need to be considered in the configuration of \verb|run.***.conf|:
\begin{itemize}
 \item All variables required for the computation of the child domain are have already been generated with the computation of the parent domain as history output.
 \item The interval of the history output is sufficiently short.
 \item The history in the parent domain is output at the model levels.
 \item The ``catalog file,'' which gives information pertaining to the parent’s calculation domain
   to the child domain, is output.
 \item In case the starting time of the computation in the child domain is the same as that in the parent domain,
 history output data at $t=0$ in the parent domain is required.
\end{itemize}
These configuration are found in the following in \ppconf and \runconf, respectively.
The part in blue corresponds to the above cautionary note:
\editboxtwo{
\verb|&PARAM_DOMAIN_CATALOGUE| & \\
\verb| DOMAIN_CATALOGUE_FNAME  = "latlon_domain_catalogue_d01.txt",| & Name of catalog file\\
\textcolor{blue}{\verb| DOMAIN_CATALOGUE_OUTPUT = .true.,|} & Output the catalog file\\
\verb|/| \\
}
\editboxtwo{
\verb|&PARAM_FILE_HISTORY| &\\
\verb| FILE_HISTORY_DEFAULT_BASENAME  = "history",| & \\
\textcolor{blue}{\verb| FILE_HISTORY_DEFAULT_TINTERVAL = 900.D0,|} & Time interval of history data output\\
\verb| FILE_HISTORY_DEFAULT_TUNIT     = "SEC",|   & Unit of \verb|FILE_HISTORY_DEFAULT_TINTERVAL|\\
\verb| FILE_HISTORY_DEFAULT_TAVERAGE  = .false.,| & \\
\verb| FILE_HISTORY_DEFAULT_DATATYPE  = "REAL4",| & \\
\textcolor{blue}{\verb| FILE_HISTORY_DEFAULT_ZCOORD   = "model",|}  & Output the data at model surface\\
\textcolor{blue}{\verb| FILE_HISTORY_OUTPUT_STEP0      = .true.,|}  & Include the output data at $t=0$ \\
\verb|/| \\
}

If the output option of the catalog file is \verb|.true.|, the file \verb|latlon_domain_catalogue_d01.txt| is output. In the case ``the making tool for the complete settings of the experiment'' is used, the file with the same name is generated in the directory \verb|pp|. In this file, the latitudes and longitudes of the four corners of the regions where each MPI manages the parent domain calculation are described. \nmitem{FILE_HISTORY_DEFAULT_TINTERVAL} is the time interval of the history output,  which is configured as the update time interval used in the calculation of the child domain. Take care of the free disk space if the time interval of the data output is relatively short. Refer to Section \ref{sec:output} for details of the items in \namelist{PARAM_FILE_HISTORY}.

All necessary variables for the generation of initial and boundary data for the child domain must be described  in \namelist{HISTORY_ITEM} in the file \runconf.
The necessary variables for offline nesting are shown below. Once this configuration is complete, conduct the time integration of the parent domain by \verb|scale-rm|.
\begin{alltt}
  T2, MSLP, DENS, MOMZ, MOMX, MOMY, RHOT, QV
  LAND_SFC_TEMP, URBAN_SFC_TEMP, OCEAN_SFC_TEMP
  OCEAN_SFC_ALB_IR_dir OCEAN_SFC_ALB_IR_dif,
  OCEAN_SFC_ALB_NIR_dir OCEAN_SFC_ALB_NIR_dif,
  OCEAN_SFC_ALB_VIS_dir OCEAN_SFC_ALB_VIS_dif,
  LAND_SFC_ALB_IR_dir, LAND_SFC_ALB_IR_dif,
  LAND_SFC_ALB_NIR_dir, LAND_SFC_ALB_NIR_dif,
  LAND_SFC_ALB_VIS_dir, LAND_SFC_ALB_VIS_dif,
  OCEAN_TEMP, OCEAN_SFC_Z0M, LAND_TEMP, LAND_WATER
\end{alltt}
(Output according to microphysics model used in the parent model)
\begin{alltt}
  QC, QR, QI, QS, QG
  NC, NR, NI, NS, NG
\end{alltt}

%-------------------------------------------------------------
\subsubsection{Generation of Initial and Boundary Data for Child Domain}


To prepare the configuration files for simulations in the child domain can be generated by using ``the supporting tool for the preparation of configuration file'' (See \ref{sec:basic_makeconf}).
Rename the sample files \\ \verb|${Tutorial_dir}/real/sample/USER.offline-nesting-child.sh| to USER.sh, and run \verb|make|.

We generate the initial and boundary data using the history data from the simulation data of the parent domain.
The execution program typically used is \verb|scale-rm_init|.
\initconf is configured as follows:
\editboxtwo{
\textcolor{blue}{\verb|&PARAM_NEST|} & \\
\textcolor{blue}{\verb| OFFLINE_PARENT_BASENAME   = "history_d01",|}  & file name of the parent domain \\
\textcolor{blue}{\verb| OFFLINE_PARENT_PRC_NUM_X  = 2,|}  & \verb|PRC_NUM_X| in the file \verb|run.d01.conf|\\
\textcolor{blue}{\verb| OFFLINE_PARENT_PRC_NUM_Y  = 2,|}  & \verb|PRC_NUM_Y|  in the file \verb|run.d01.conf|\\
\textcolor{blue}{\verb| LATLON_CATALOGUE_FNAME    =| \textbackslash} &\\
\textcolor{blue}{\hspace{1cm}\verb| "latlon_domain_catalogue_d01.txt",|} & catalog file generated at the parent domain process\\
\textcolor{blue}{\verb|/|} &\\
 & \\
\verb|&PARAM_MKINIT_REAL_ATMOS| &\\
\textcolor{blue}{\verb| NUMBER_OF_TSTEPS    = 25,|}         & number of time steps in the history file\\
\verb| BASENAME_ORG        = "history_d01",|  & \verb|FILE_HISTORY_DEFAULT_BASENAME| in the file \verb|run.d01.conf|\\
\verb| FILETYPE_ORG        = "SCALE-RM",| & \\
\verb| BASENAME_BOUNDARY   = "boundary_d01",| &\\
\textcolor{blue}{\verb| BOUNDARY_UPDATE_DT  = 900.D0,|}     & time interval of history output（unit:\verb|"SEC"|）\\
\verb|/| &\\
 & \\
\verb|&PARAM_MKINIT_REAL_OCEAN| &\\
\textcolor{blue}{\verb| NUMBER_OF_TSTEPS    = 25,|}         & number of time steps in the history file\\
\verb| BASENAME_ORG        = "history_d01",|  & \verb|FILE_HISTORY_DEFAULT_BASENAME| in the file \verb|run.d01.conf|\\
\verb| FILETYPE_ORG        = "SCALE-RM",| & \\
\verb| BASENAME_BOUNDARY   = "boundary_d01",| &\\
\textcolor{blue}{\verb| BOUNDARY_UPDATE_DT  = 900.D0,|}     & time interval of history output（unit:\verb|"SEC"|）\\
\verb|/| &\\
 & \\
\verb|&PARAM_MKINIT_REAL_LAND| &\\
\textcolor{blue}{\verb| NUMBER_OF_TSTEPS    = 25,|}         & number of time steps in the history file\\
\verb| BASENAME_ORG        = "history_d01",|  & \verb|FILE_HISTORY_DEFAULT_BASENAME| in the file \verb|run.d01.conf|\\
\verb| FILETYPE_ORG        = "SCALE-RM",| & \\
\verb| BASENAME_BOUNDARY   = "boundary_d01",| &\\
\textcolor{blue}{\verb| BOUNDARY_UPDATE_DT  = 900.D0,|}     & time interval of history output（unit:\verb|"SEC"|）\\
\verb|/| &\\
}

In the case of generation of initial and boundary data from the output of \scalerm format,
\nmitem{FILETYPE_ORG} is specified as \verb|"SCALE-RM"|.
\nmitem{BOUNDARY_UPDATE_DT} is set to the same value of \nmitem{FILE_HISTORY_DEFAULT_TINTERVAL}
as in the configuration file in the parent domain (\verb|run.d01.conf|).
The items in \namelist{PARAM_NEST} are prepared for the nesting experiment.
In offline nesting,  the file name of the data in the parent domain is specified as \nmitem{OFFLINE_PARENT_BASENAME} .
The number of processes of the parent domain is also specified as \nmitem{OFFLINE_PARENT_PRC_NUM_*}.
Configure them correctly by referring to the configuration file for the parent domain (\verb|run.d01.conf|). After editing the configuration file, form the initial and boundary data for the child domain by \verb|scale-rm_init|.
If the execution is aborted with the message like the following, it means that the child domain is not completely contained in the parent domain:
\msgbox{
\verb|ERROR [INTERP_domain_compatibility] REQUESTED DOMAIN IS TOO MUCH BROAD| \\
\verb|     -- LONGITUDINAL direction over the limit| \\
}


\subsubsection{Time Integration in Child Domain}

Following the generation of the initial and boundary conditions, compute the time integration in the child domain by \verb|scale-rm|. This is same as in the usual atmospheric experiment. Before this, confirm that \nmitem{ATMOS_BOUNDARY_UPDATE_DT}  of \namelist{PARAM_ATMOS_BOUNDARY} in the file \runconf is the same as the time interval of the output of history data for the parent domain. Note that the calculation continues without any message even if these time intervals are inconsistent in the current version.
\editbox{
\verb|&PARAM_ATMOS_BOUNDARY| \\
\textcolor{blue}{\verb| ATMOS_BOUNDARY_UPDATE_DT  = 900.D0,|} \\
\verb|/| \\
}

If an experiment involving multiple offline nestings is performed, the above procedure is repeated; the results of the above time integration for the child domain are regarded as those for the parent domain, and the initial and boundary data are generated for further inner domain calculations. 
