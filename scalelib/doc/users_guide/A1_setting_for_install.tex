\chapter{ライブラリ環境のインストール}
\label{sec:env_setting}

\section{インストールに関する基礎知識}

Linuxをインストール後、各種プログラムのインストールにはコマンドライン端末を使う。
コマンドラインのシンボル（\verb|$, #|）は、コマンドの実行を示す。
下記の表記の違いは、プログラムを実行する権限の違いを示している。

\begin{verbatim}
 #        <- root権限で実行するコマンド
 $        <- ユーザ権限で実行するコマンド
\end{verbatim}
権限の一時的な切り替えにはsuコマンドを用いる。
\verb|{User_Name}|は実際のユーザ名に読み替えること。
\begin{verbatim}
 $ su {User_Name}   <- {User_Name}のユーザー名でログイン
 $ exit             <- {User_Name}のユーザー名でログインを修了
 $ su -             <- root権限に変更
 #
\end{verbatim}

コマンドオプションにハイフンを用いると、そのユーザでのログインを行う。
用いない場合、権限のみの変更となる。またユーザ名を省略するとrootでのログインを試す。
ユーザの一時切り替えを終わるには、exitコマンドを用いる。
各プログラムをインストールするための圧縮ファイルは、/tmpにダウンロードされていると仮定する。
他のディレクトリにダウンロードしてある場合は、mvコマンド等を用いて/tmpに移動しておくことを勧める。
コード表記のうち、ダブルスラッシュ（//）で始まる行は解説のためのもので、実際に記述する必要はない。


\begin{verbatim}
 $ vi
\end{verbatim}

上記のコマンドは、vi（汎用テキストエディタ）プログラムを実行する。
他に、gedit、emacsなどのテキストエディタがある。
マニュアルではviコマンドの実行指示があるが、各自の使いやすいエディタへ適宜読み替えること。

\section{インストール(Linux,CentOS編)}

\subsubsection{各種インストールの事前準備}

SCALEのインストールに必要な開発ツールやライブラリのインストール方法について説明する。
ここでは簡単のため、Red Had Enterpise LinuxのクローンOSとして有名なCentOSを例に、
パッケージマネージャを利用した方法を紹介する。
他のOSでは適宜読み替えること。例えばUbuntuなどではyumではなくapt系コマンドを用いる。

CentOSではいくつかの開発ツール、ライブラリを外部リポジトリから持ってくる必要がある。
具体的にはepelリポジトリ。ルート権限になり，外部リポジトリを認識させる。
\begin{verbatim}
 # yum install epel-release
\end{verbatim}
yumのグループインストール機能を用いて，開発ツールをまとめてインストールする。
\begin{verbatim}
 # yum groupinstall "development tools"
\end{verbatim}
グループインストールではインストールされないパッケージを個別に追加する。
\begin{verbatim}
 # yum install hdf5-devel hdf5-static
 # yum install netcdf-devel netcdf-static
 # yum install openmpi-devel
 # yum install lapack lapack-devel
\end{verbatim}


\subsubsection{MPI設定}

SCALEをマルチプロセッサで走らせるため、OpenMPIの設定を行う。
ユーザ権限に移動して.bashrcをエディタで開き，
\begin{verbatim}
 $ vi ~/.bashrc
\end{verbatim}
下記をファイルの最後に追加して，環境変数の設定を記述する。
\begin{verbatim}
 // ---------------- Add to end of the file ----------------
 # OpenMPI
 export MPI="/usr/lib64/openmpi"
 export PATH="$PATH:$MPI/bin"
 export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$MPI/lib"
\end{verbatim}
編集が終わったら、環境設定を有効にする。
\begin{verbatim}
 $ . ~/.bashrc
\end{verbatim}


\subsubsection{Installation of Gphys}

CentOSの場合、yumリポジトリに地球電脳倶楽部のGFD-Dennouリポジトリを登録することで、
簡単にGphysをインストールできる。
root権限で、GFD-Dennouリポジトリを次のような内容で登録する。

\begin{verbatim}
 # vi /etc/yum.repos.d/GFD-Dennou.repo
\end{verbatim}

\begin{verbatim}
 // ---------------- Edit the file ----------------
 [gfd-dennou]
 name=GFD DENNOU Club RPMS for CentOS $releasever - $basearch
 baseurl=http://www.gfd-dennou.org/library/cc-env/rpm-dennou/CentOS/$releasever/$basearch/
 enabled=1
 gpgcheck=0
\end{verbatim}
編集が終わったら、yumでGphysをインストールする。
\begin{verbatim}
 # yum install gphys
\end{verbatim}

\section{インストール(MacOSX編)}

\subsubsection{macportsを用いたインストール}

Apple MacOSXでのSCALE実行環境を整備する方法について説明する。
ここではMacOSXのパッケージマネージャの一つであるmacportsを用いる方法を紹介する。
その他の主要なパッケージマネージャとしては、homebrewが挙げられる。homebrewを利用しても環境は手軽に揃えられるので、
興味のある方は利用してもらいたい。

まずはAppleの開発ツールであるXcodeをインストールする。
大元のgccコンパイラを導入するために、必ずインストールする必要がある。
最近のOSのバージョンのものは、App Store経由で入手できる（無料）。
古いOSでは、インストールディスクから追加することが出来る。
最近のOSのXcodeの場合、最初に以下の様な設定をターミナルから行う必要がある。
\begin{verbatim}
 コマンドラインツールのインストール
 # xcode-select --install
\end{verbatim}
\begin{verbatim}
 ライセンス条項の承認
 # xcodebuild -license
\end{verbatim}

次にmacports本体をインストールする。
\url{https://www.macports.org/}

macportsとmacportsが管理するパッケージは/opt/local以下に配置される。
インストール時に\verb|.bash_profile|に、/opt/local/binへのパスが張られているので確認されたし。
macportsはコマンドラインから操作する。主要なコマンドは以下の通り。

\begin{verbatim}
 インストール可能なソフトウェアを検索する
 $ port search <検索文字>
\end{verbatim}
\begin{verbatim}
 ソフトウェアのインストール時に選択可能なオプション(variants)を確認する
 $ port variants <アプリ名>
\end{verbatim}
\begin{verbatim}
 ソフトウェアのインストール（root権限必要）
 $ sudo port install <アプリ名> [variants]
\end{verbatim}
\begin{verbatim}
 ソフトウェアのアンインストール（root権限必要）
 $ sudo port uninstall <アプリ名> [variants]
\end{verbatim}
\begin{verbatim}
 macports本体とパッケージカタログの更新（root権限必要）
 $ sudo port selfupdate
\end{verbatim}
\begin{verbatim}
 パッケージの更新（root権限必要）
 $ sudo port upgrade outdated
\end{verbatim}
\begin{verbatim}
 不要なパッケージ（activateされていない過去のバージョン等）の削除
 $ sudo port -u uninstall
\end{verbatim}

\subsubsection{gccからNetCDFまでのインストール}

macportsはパッケージの依存関係を解決してくれるが、必要なvariantsを備えたセットを作るには、
順番にインストールしていく方が問題が少ない。以下にsudo port installしていく順番とvariantsの設定を示す。
今回はgcc4.9の利用を想定している。
\begin{verbatim}
 $ gcc49
 $ openmpi-gcc49 +threads
 $ hdf4 +gcc49 +szip
 $ hdf5 +gcc49 +szip +fortran +cxx +openmpi +threadsafe
 $ netcdf +gcc49 +openmpi +netcdf4 +hdf4
 $ netcdf-fortran +gcc49 +openmpi
\end{verbatim}

最近のmacportsでは、gccとmpiライブラリはselectで選択する。
この操作を行うと、gfortran等の一般的な名前でエイリアスが作られてパスが通るようになる。
\begin{verbatim}
 $ sudo port select --set gcc mp-gcc49
 $ sudo port select --set mpi openmpi-gcc49-fortran
\end{verbatim}

SCALEは陰解法計算の部分で、数値計算ライブラリを利用するオプションがある。
もし必要ならば、macportsからATLASをインストールすることが出来る。
\begin{verbatim}
 $ atlas +gcc49
\end{verbatim}

\subsubsection{rubyからGphysまでのインストール}

macports-JPが作成しているリポジトリから、MacOSX用のGPhysをインストールできる。
以下のように、MacPorts-JPのリポジトリをチェックアウトして配置する。場所は好きな場所でよい。
\begin{verbatim}
 $ sudo svn co http://svn.sourceforge.jp/svnroot/macports-jp/trunk/ \
 $ /opt/local/var/sources/svn.sourceforge.jp/svnroot/macports-jp/trunk
\end{verbatim}
/opt/local/etc/macports/sources.confに、チェックアウトしたリポジトリを追加する。
\begin{verbatim}
 file:///opt/local/var/sources/svn.sourceforge.jp/svnroot/macports-jp/trunk/dports
\end{verbatim}
これで、Gphysと関連ライブラリをmacportsで一括インストールできるようになる。
今回はruby1.9向けのrb19-gphysをインストールすることにする。

\begin{verbatim}
 rubyのインストールと1.9の選択
 $ sudo port install ruby19
 $ sudo port select --set ruby ruby19
\end{verbatim}
\begin{verbatim}
 依存関係の解決を任せるかたちで、gphysのインストール
 $ sudo port install rb19-gphys
\end{verbatim}

インストールされたruby1.9版gphysコマンドは、末尾に1.9が付いている。
これを無くしたい場合は/opt/local/bin内でシンボリックリンクを張る。
以下では特に頻繁に使う３つを例に挙げる。
\begin{verbatim}
 $ sudo ln -s gpvlist1.9 gplist
 $ sudo ln -s gpvect1.9 gpvect
 $ sudo ln -s gpview1.9 gpview
\end{verbatim}

\subsubsection{その他のインストール}

macportsでインストールできるパッケージのうち、重要なものを以下に紹介する。

\begin{itemize}
\item git, git-flow : ソースコード開発時に利用する。
\item coreutils : GNU core utils。様々な場面で必要になる。
\item gawk, gsed : MacOSXに付属するawk,sedはGNU版と機能が異なるため、こちらが必要になる時がある。
\item gnuplot : グラフ描画に利用。
\item ImageMagick : Gphysから出力したPostScriptファイルをpngやアニメーションgifに変換する時に利用。
\end{itemize}

